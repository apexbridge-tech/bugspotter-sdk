name: CDN Deployment

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 0.3.1)'
        required: true
        type: string

env:
  NODE_VERSION: '22'

jobs:
  cdn-deploy:
    name: Deploy to CDN
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build package
        run: pnpm --filter @bugspotter/sdk build

      - name: Prepare CDN assets
        run: |
          set -e
          mkdir -p cdn-deploy
          cd packages/core/dist

          # Verify build artifacts exist
          if [ ! -f "bugspotter.min.js" ]; then
            echo "‚ùå Error: bugspotter.min.js not found!"
            exit 1
          fi

          # Copy UMD bundle (main file)
          cp bugspotter.min.js ../../../cdn-deploy/bugspotter-${{ inputs.version }}.min.js
          cp bugspotter.min.js ../../../cdn-deploy/bugspotter-latest.min.js

          # Copy source maps if they exist (both versioned and latest)
          if [ -f "bugspotter.min.js.map" ]; then
            cp bugspotter.min.js.map ../../../cdn-deploy/bugspotter-${{ inputs.version }}.min.js.map
            cp bugspotter.min.js.map ../../../cdn-deploy/bugspotter-latest.min.js.map
          fi

          echo "‚úÖ Prepared CDN assets"
          ls -lh ../../../cdn-deploy/

      - name: Deploy to Backblaze B2 + BunnyCDN
        env:
          B2_APPLICATION_KEY_ID: ${{ secrets.B2_APPLICATION_KEY_ID }}
          B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
          B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}
          B2_ENDPOINT: ${{ secrets.B2_ENDPOINT }}
          CDN_URL: ${{ secrets.CDN_URL }}
          BUNNY_API_KEY: ${{ secrets.BUNNY_API_KEY }}
          BUNNY_PULL_ZONE_ID: ${{ secrets.BUNNY_PULL_ZONE_ID }}
        run: |
          set -e
          # Install B2 CLI
          python3 -m pip install --upgrade b2

          # Authorize B2 account
          b2 account authorize ${B2_APPLICATION_KEY_ID} ${B2_APPLICATION_KEY}

          echo "üì¶ Uploading to Backblaze B2 bucket: ${B2_BUCKET_NAME}"

          # Upload versioned file with long cache
          b2 file upload \
            --content-type "application/javascript" \
            --info "cache-control=public, max-age=31536000, immutable" \
            ${B2_BUCKET_NAME} \
            cdn-deploy/bugspotter-${{ inputs.version }}.min.js \
            sdk/bugspotter-${{ inputs.version }}.min.js

          echo "‚úÖ Uploaded versioned file: sdk/bugspotter-${{ inputs.version }}.min.js"

          # Upload latest file with short cache
          b2 file upload \
            --content-type "application/javascript" \
            --info "cache-control=public, max-age=300" \
            ${B2_BUCKET_NAME} \
            cdn-deploy/bugspotter-latest.min.js \
            sdk/bugspotter-latest.min.js

          echo "‚úÖ Uploaded latest file: sdk/bugspotter-latest.min.js"

          # Upload versioned source map if exists
          if [ -f "cdn-deploy/bugspotter-${{ inputs.version }}.min.js.map" ]; then
            b2 file upload \
              --content-type "application/json" \
              --info "cache-control=public, max-age=31536000, immutable" \
              ${B2_BUCKET_NAME} \
              cdn-deploy/bugspotter-${{ inputs.version }}.min.js.map \
              sdk/bugspotter-${{ inputs.version }}.min.js.map
            
            echo "‚úÖ Uploaded versioned source map: sdk/bugspotter-${{ inputs.version }}.min.js.map"
          fi

          # Upload latest source map if exists
          if [ -f "cdn-deploy/bugspotter-latest.min.js.map" ]; then
            b2 file upload \
              --content-type "application/json" \
              --info "cache-control=public, max-age=300" \
              ${B2_BUCKET_NAME} \
              cdn-deploy/bugspotter-latest.min.js.map \
              sdk/bugspotter-latest.min.js.map
            
            echo "‚úÖ Uploaded latest source map: sdk/bugspotter-latest.min.js.map"
          fi

          echo ""
          echo "‚úÖ Deployed to Backblaze B2"

          # Purge BunnyCDN cache for latest files (JS + source map)
          if [ -n "${BUNNY_API_KEY}" ]; then
            echo ""
            echo "üîÑ Purging BunnyCDN cache..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "https://api.bunny.net/pullzone/${BUNNY_PULL_ZONE_ID}/purgeCache" \
              -H "AccessKey: ${BUNNY_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{
                "Files": [
                  "/sdk/bugspotter-latest.min.js",
                  "/sdk/bugspotter-latest.min.js.map"
                ]
              }')
            
            if [ "$HTTP_CODE" -eq 204 ] || [ "$HTTP_CODE" -eq 200 ]; then
              echo "‚úÖ BunnyCDN cache purged (HTTP $HTTP_CODE)"
            else
              echo "‚ö†Ô∏è  Warning: BunnyCDN cache purge returned HTTP $HTTP_CODE"
            fi
          fi

          echo ""
          echo "üåê CDN URLs:"
          echo "   Versioned: ${CDN_URL}/sdk/bugspotter-${{ inputs.version }}.min.js"
          echo "   Latest:    ${CDN_URL}/sdk/bugspotter-latest.min.js"
